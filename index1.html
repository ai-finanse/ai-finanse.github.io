<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinansEMG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 20px;
        }
        .dashboard {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .btn {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
            cursor: pointer;
        }
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="main" class="screen active">
        <div class="dashboard">
            <h2>üíº –ú–æ–π –∫–∞–±–∏–Ω–µ—Ç</h2>
            <div class="stat">
                <span>üìä –ë–∞–ª–∞–Ω—Å:</span>
                <strong id="balance">–∑–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
            <div class="stat">
                <span>üí∞ –ö –æ–ø–ª–∞—Ç–µ:</span>
                <strong id="tax_due">–∑–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
            <div class="stat">
                <span>üìÑ –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è:</span>
                <strong id="declaration">–∑–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
        </div>
        
        <button class="btn" onclick="showScreen('upload')">üì§ –í—ã—Å–ª–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
        <button class="btn" onclick="showScreen('chat')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</button>
        <button class="btn" onclick="showScreen('info')">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="upload" class="screen">
        <h2>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        <input type="file" id="fileInput" accept="image/*,.pdf" style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <button class="btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
        <div id="uploadStatus"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div id="chat" class="screen">
        <h2>üí¨ –ß–∞—Ç —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</h2>
        <div id="messages" style="height: 300px; overflow-y: auto; margin: 20px 0;"></div>
        <textarea id="messageInput" rows="3" style="width: 100%; padding: 10px;"></textarea>
        <button class="btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
    <div id="info" class="screen">
        <h2>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div class="dashboard">
            <h3>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h3>
            <div class="stat"><span>–ë–∞–ª–∞–Ω—Å:</span><span id="info_balance">-</span></div>
            <div class="stat"><span>–ö –æ–ø–ª–∞—Ç–µ:</span><span id="info_tax">-</span></div>
        </div>
        <div class="dashboard">
            <h3>üìÑ –î–µ–∫–ª–∞—Ä–∞—Ü–∏–∏</h3>
            <div id="declarations_list">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <button class="btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const userId = tg.initDataUnsafe?.user?.id || 'demo';
        const N8N_WEBHOOK = 'https://your-n8n-url.com/webhook/finansemg';

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'main') loadData();
            if (screenId === 'chat') loadMessages();
            if (screenId === 'info') loadInfo();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        async function loadData() {
            const response = await fetch(`${N8N_WEBHOOK}/get-client`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userId })
            });
            const data = await response.json();
            
            document.getElementById('balance').textContent = data.balance + ' z≈Ç';
            document.getElementById('tax_due').textContent = data.tax_due + ' z≈Ç';
            document.getElementById('declaration').textContent = data.declaration_sent ? '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '‚è≥ –í —Ä–∞–±–æ—Ç–µ';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('telegram_id', userId);
            
            document.getElementById('uploadStatus').textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º...';
            
            const response = await fetch(`${N8N_WEBHOOK}/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                document.getElementById('uploadStatus').textContent = '‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!';
                setTimeout(() => showScreen('main'), 2000);
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        async function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message) return;
            
            await fetch(`${N8N_WEBHOOK}/send-message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userId, message: message })
            });
            
            document.getElementById('messageInput').value = '';
            loadMessages();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
        async function loadMessages() {
            const response = await fetch(`${N8N_WEBHOOK}/get-messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userId })
            });
            const messages = await response.json();
            
            const html = messages.map(m => 
                `<div style="padding: 10px; margin: 5px 0; background: ${m.from === 'client' ? '#e3f2fd' : '#f5f5f5'}; border-radius: 8px;">
                    <strong>${m.from === 'client' ? '–í—ã' : '–ú–µ–Ω–µ–¥–∂–µ—Ä'}:</strong> ${m.message}
                </div>`
            ).join('');
            
            document.getElementById('messages').innerHTML = html;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        async function loadInfo() {
            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ loadData(), –Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π
            loadData();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>
</html>
