<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI FINANSE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --brand: #0066FF;
            --brand-dark: #0052CC;
            --brand-light: #E6F0FF;
            --green: #00C48C;
            --green-bg: #E6FAF3;
            --red: #FF4757;
            --red-bg: #FFE8EB;
            --orange: #FF9F43;
            --orange-bg: #FFF4E6;
            --bg: #F0F2F5;
            --card: #FFFFFF;
            --text: #1A1D21;
            --text2: #6B7280;
            --text3: #9CA3AF;
            --border: #E5E7EB;
            --input-bg: #F9FAFB;
            --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 14px;
            --radius-sm: 10px;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            background: var(--brand);
            padding: 18px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1.5px;
        }
        .header-logo span { color: rgba(255,255,255,0.5); font-weight: 400; }

        .container { padding: 16px; max-width: 480px; margin: 0 auto; }

        .screen { display: none; }
        .screen.active { display: block; animation: slideIn 0.25s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }
        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title .icon { font-size: 18px; }

        .form-group { margin-bottom: 14px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text2);
            margin-bottom: 6px;
        }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(0,102,255,0.12);
            background: #fff;
        }
        .form-input::placeholder { color: var(--text3); }

        select.form-input {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .code-wrapper {
            display: flex; flex-direction: column; align-items: center; padding: 40px 20px;
        }
        .code-icon { font-size: 56px; margin-bottom: 20px; }
        .code-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .code-subtitle { font-size: 14px; color: var(--text2); margin-bottom: 32px; }
        .code-inputs { display: flex; gap: 8px; margin-bottom: 24px; }
        .code-digit {
            width: 48px; height: 56px; border: 2px solid var(--border);
            border-radius: var(--radius-sm); text-align: center;
            font-size: 24px; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: var(--input-bg); color: var(--text);
            transition: all 0.2s; -webkit-appearance: none;
        }
        .code-digit:focus {
            outline: none; border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(0,102,255,0.15); background: #fff;
        }
        .code-digit.filled { border-color: var(--brand); background: var(--brand-light); }
        .code-digit.error-shake { border-color: var(--red); animation: shake 0.4s ease; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }
        .forgot-link {
            font-size: 14px; color: var(--brand); cursor: pointer;
            font-weight: 500; border: none; background: none; padding: 8px;
        }

        .btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 16px; border: none; border-radius: var(--radius-sm);
            font-size: 15px; font-weight: 600; font-family: inherit; cursor: pointer;
            transition: all 0.15s; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--brand); color: #fff; }
        .btn-primary:hover { background: var(--brand-dark); }
        .btn-primary:disabled { background: #B0C4DE; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--input-bg); color: var(--text); border: 1.5px solid var(--border); }
        .btn-green { background: var(--green); color: #fff; }
        .btn-outline { background: transparent; color: var(--brand); border: 1.5px solid var(--brand); }
        .btn .btn-icon { font-size: 18px; }
        .btn + .btn { margin-top: 10px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 4px; }
        .stat-box {
            background: var(--input-bg); border-radius: var(--radius-sm);
            padding: 16px 14px; text-align: center; border: 1px solid var(--border);
        }
        .stat-label {
            font-size: 11px; font-weight: 600; color: var(--text3);
            text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px;
        }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; }
        .stat-value.blue { color: var(--brand); }
        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.orange { color: var(--orange); }

        .menu-grid { display: flex; flex-direction: column; gap: 8px; }
        .menu-btn {
            display: flex; align-items: center; gap: 14px; padding: 16px;
            background: var(--card); border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s;
        }
        .menu-btn:active { transform: scale(0.98); background: var(--input-bg); }
        .menu-btn .m-icon {
            width: 42px; height: 42px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .menu-btn .m-icon.blue { background: var(--brand-light); }
        .menu-btn .m-icon.green { background: var(--green-bg); }
        .menu-btn .m-icon.orange { background: var(--orange-bg); }
        .menu-btn .m-text { flex: 1; }
        .menu-btn .m-title { font-size: 15px; font-weight: 600; }
        .menu-btn .m-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }
        .menu-btn .m-arrow { color: var(--text3); font-size: 18px; }

        .upload-zone {
            border: 2px dashed var(--border); border-radius: var(--radius);
            padding: 32px 20px; text-align: center; cursor: pointer;
            transition: all 0.2s; margin-bottom: 16px;
        }
        .upload-zone:active { border-color: var(--brand); background: var(--brand-light); }
        .upload-zone .uz-icon { font-size: 40px; margin-bottom: 10px; }
        .upload-zone .uz-text { font-size: 15px; font-weight: 500; color: var(--text2); }
        .upload-zone .uz-hint { font-size: 12px; color: var(--text3); margin-top: 6px; }

        .upload-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .upload-action-btn {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 14px 8px; background: var(--input-bg); border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer; font-family: inherit;
            font-size: 12px; font-weight: 500; color: var(--text2);
        }
        .upload-action-btn:active { background: var(--brand-light); border-color: var(--brand); }
        .upload-action-btn .ua-icon { font-size: 24px; }

        .doc-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            background: var(--input-bg); border-radius: var(--radius-sm); margin-bottom: 6px;
        }
        .doc-item .di-icon { font-size: 22px; }
        .doc-item .di-name { font-size: 14px; font-weight: 500; }
        .doc-item .di-date { font-size: 11px; color: var(--text3); }

        .chat-box {
            height: 380px; overflow-y: auto; padding: 14px;
            background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 12px;
        }
        .msg {
            max-width: 80%; padding: 10px 14px; border-radius: 14px;
            margin-bottom: 8px; font-size: 14px; line-height: 1.45; word-wrap: break-word;
        }
        .msg.client { background: var(--brand); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .msg.manager { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg-sender { font-size: 11px; font-weight: 600; margin-bottom: 3px; opacity: 0.75; }
        .msg-time { font-size: 10px; margin-top: 4px; opacity: 0.6; }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input-row textarea {
            flex: 1; padding: 12px 14px; border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); font-size: 15px; font-family: inherit;
            resize: none; background: var(--input-bg);
        }
        .chat-input-row textarea:focus { outline: none; border-color: var(--brand); }
        .chat-send-btn {
            width: 48px; height: 48px; border-radius: var(--radius-sm); border: none;
            background: var(--brand); color: #fff; font-size: 20px; cursor: pointer;
        }

        .toggle-row {
            display: flex; background: var(--input-bg); border-radius: var(--radius-sm);
            padding: 4px; margin-bottom: 16px; border: 1px solid var(--border);
        }
        .toggle-opt {
            flex: 1; padding: 10px; text-align: center; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none; background: transparent; font-family: inherit; color: var(--text2);
        }
        .toggle-opt.active { background: var(--brand); color: #fff; box-shadow: var(--shadow); }

        .invoice-actions {
            display: flex; flex-direction: column; gap: 8px;
            margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);
        }

        .alert-toast {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px;
            font-weight: 500; z-index: 999; max-width: 90%; text-align: center;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
        }
        .alert-toast.success { background: var(--green); color: #fff; }
        .alert-toast.error { background: var(--red); color: #fff; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--brand); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state { text-align: center; padding: 40px 20px; color: var(--text2); }
        .loading-state p { margin-top: 12px; font-size: 14px; }

        .divider { height: 1px; background: var(--border); margin: 16px 0; }

        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 13px 0; border-bottom: 1px solid var(--border); }
        .info-row:last-child { border-bottom: none; }
        .info-row .ir-label { font-size: 14px; color: var(--text2); }
        .info-row .ir-value { font-size: 14px; font-weight: 600; }

        .back-row { margin-top: 8px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-logo">AI <span>|</span> FINANSE</div>
</div>

<div class="container">

    <!-- PAGE 1: LOGIN -->
    <div id="page-login" class="screen active">
        <div class="card">
            <div class="code-wrapper">
                <div class="code-icon">üîê</div>
                <div class="code-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</div>
                <div class="code-subtitle">6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
                <div class="code-inputs" id="codeInputs">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="0" inputmode="numeric" autocomplete="off">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="1" inputmode="numeric" autocomplete="off">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="2" inputmode="numeric" autocomplete="off">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="3" inputmode="numeric" autocomplete="off">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="4" inputmode="numeric" autocomplete="off">
                    <input type="tel" maxlength="1" class="code-digit" data-idx="5" inputmode="numeric" autocomplete="off">
                </div>
                <button class="forgot-link" onclick="showScreen('page-forgot')">–ó–∞–±—ã–ª–∏ –∫–æ–¥?</button>
            </div>
        </div>
    </div>

    <!-- PAGE 11: FORGOT CODE -->
    <div id="page-forgot" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üîë</span> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</div>
            <div class="form-group">
                <label class="form-label">NIP –∫–æ–º–ø–∞–Ω–∏–∏</label>
                <input type="tel" class="form-input" id="forgotNip" placeholder="0000000000" maxlength="10" inputmode="numeric">
            </div>
            <div class="form-group">
                <label class="form-label">PESEL –≤–ª–∞–¥–µ–ª—å—Ü–∞</label>
                <input type="tel" class="form-input" id="forgotPesel" placeholder="00000000000" maxlength="11" inputmode="numeric">
            </div>
            <button class="btn btn-primary" onclick="verifyIdentity()">
                <span class="btn-icon">‚úì</span> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
        </div>
        <div class="back-row">
            <button class="btn btn-secondary" onclick="showScreen('page-login')"><span class="btn-icon">‚Üê</span> –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- PAGE 12: NEW CODE -->
    <div id="page-newcode" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üîí</span> –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
            <div class="form-group">
                <label class="form-label">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ (6 —Ü–∏—Ñ—Ä)</label>
                <input type="tel" class="form-input" id="newCode" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" style="font-family:'JetBrains Mono',monospace;letter-spacing:8px;text-align:center;font-size:24px;">
            </div>
            <div class="form-group">
                <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∫–æ–¥</label>
                <input type="tel" class="form-input" id="confirmCode" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" style="font-family:'JetBrains Mono',monospace;letter-spacing:8px;text-align:center;font-size:24px;">
            </div>
            <button class="btn btn-primary" onclick="saveNewCode()"><span class="btn-icon">üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–¥</button>
        </div>
    </div>

    <!-- PAGE 2: COMPANY DATA -->
    <div id="page-company" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üè¢</span> –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                <input type="text" class="form-input" id="compName" placeholder="Nazwa firmy">
            </div>
            <div class="divider"></div>
            <div class="card-title" style="font-size:13px;margin-bottom:12px;"><span class="icon">üìç</span> –ê–¥—Ä–µ—Å</div>
            <div class="form-group">
                <label class="form-label">–£–ª–∏—Ü–∞</label>
                <input type="text" class="form-input" id="compStreet" placeholder="ul. Przyk≈Çadowa">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–î–æ–º / –û—Ñ–∏—Å</label>
                    <input type="text" class="form-input" id="compBuilding" placeholder="10/2">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ—á—Ç–æ–≤—ã–π –∫–æ–¥</label>
                    <input type="text" class="form-input" id="compZip" placeholder="00-000" maxlength="6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–ì–æ—Ä–æ–¥</label>
                    <input type="text" class="form-input" id="compCity" placeholder="Warszawa">
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                    <select class="form-input" id="compCountry">
                        <option value="PL">Polska</option>
                        <option value="DE">Niemcy</option>
                        <option value="AT">Austria</option>
                        <option value="CZ">Czechy</option>
                        <option value="UA">Ukraina</option>
                        <option value="OTHER">Inne</option>
                    </select>
                </div>
            </div>
            <div class="divider"></div>
            <div class="card-title" style="font-size:13px;margin-bottom:12px;"><span class="icon">üìã</span> –†–µ–∫–≤–∏–∑–∏—Ç—ã</div>
            <div class="form-group">
                <label class="form-label">NIP</label>
                <input type="tel" class="form-input" id="compNip" placeholder="0000000000" maxlength="10" inputmode="numeric">
            </div>
            <div class="form-group">
                <label class="form-label">IBAN (–Ω–æ–º–µ—Ä —Å—á—ë—Ç–∞)</label>
                <input type="text" class="form-input" id="compIban" placeholder="PL00 0000 0000 0000 0000 0000 0000">
            </div>
            <div class="form-group" id="swiftGroup" style="display:none;">
                <label class="form-label">SWIFT / BIC</label>
                <input type="text" class="form-input" id="compSwift" placeholder="BREXPLPW">
            </div>
            <div class="form-group">
                <label class="form-label">–û—Å–Ω–æ–≤–Ω–æ–π PKD</label>
                <input type="text" class="form-input" id="compPkd" placeholder="62.01.Z">
            </div>
        </div>
        <button class="btn btn-primary" onclick="saveCompanyData()"><span class="btn-icon">üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn btn-secondary" onclick="showScreen('page-dashboard')" id="compBackBtn" style="display:none;"><span class="btn-icon">‚Üê</span> –ù–∞–∑–∞–¥</button>
    </div>

    <!-- PAGE 3: DASHBOARD -->
    <div id="page-dashboard" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üìä</span> –§–∏–Ω–∞–Ω—Å—ã</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">–ü—Ä–∏—Ö–æ–¥</div><div class="stat-value green" id="dPrihod">‚Äî</div></div>
                <div class="stat-box"><div class="stat-label">–†–∞—Å—Ö–æ–¥</div><div class="stat-value red" id="dRashod">‚Äî</div></div>
                <div class="stat-box"><div class="stat-label">–î–æ—Ö–æ–¥</div><div class="stat-value blue" id="dDohod">‚Äî</div></div>
                <div class="stat-box"><div class="stat-label">–ù–î–° (VAT)</div><div class="stat-value orange" id="dVat">‚Äî</div></div>
                <div class="stat-box"><div class="stat-label">PIT</div><div class="stat-value blue" id="dPit">‚Äî</div></div>
                <div class="stat-box"><div class="stat-label">ZUS</div><div class="stat-value blue" id="dZus">‚Äî</div></div>
            </div>
        </div>
        <div class="menu-grid">
            <div class="menu-btn" onclick="showScreen('page-invoice')">
                <div class="m-icon green">üìù</div>
                <div class="m-text"><div class="m-title">–í—ã–ø–∏—Å–∞—Ç—å —Å—á—ë—Ç</div><div class="m-desc">–§–∞–∫—Ç—É—Ä–∞ –∏–ª–∏ –ø—Ä–æ—Ñ–æ—Ä–º–∞</div></div>
                <div class="m-arrow">‚Ä∫</div>
            </div>
            <div class="menu-btn" onclick="showScreen('page-upload')">
                <div class="m-icon blue">üì§</div>
                <div class="m-text"><div class="m-title">–í—ã—Å–ª–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</div><div class="m-desc">–§–æ—Ç–æ, —Å–∫–∞–Ω—ã, PDF</div></div>
                <div class="m-arrow">‚Ä∫</div>
            </div>
            <div class="menu-btn" onclick="showScreen('page-chat')">
                <div class="m-icon orange">üí¨</div>
                <div class="m-text"><div class="m-title">–ß–∞—Ç —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</div><div class="m-desc">–°–≤—è–∑–∞—Ç—å—Å—è —Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º</div></div>
                <div class="m-arrow">‚Ä∫</div>
            </div>
            <div class="menu-btn" onclick="showScreen('page-info')">
                <div class="m-icon blue">üìã</div>
                <div class="m-text"><div class="m-title">–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div><div class="m-desc">–¢–∞—Ä–∏—Ñ, –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div></div>
                <div class="m-arrow">‚Ä∫</div>
            </div>
        </div>
    </div>

    <!-- PAGE 4: UPLOAD -->
    <div id="page-upload" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üì§</span> –í—ã—Å–ª–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
            <input type="file" id="fileGallery" accept="image/*" style="display:none" multiple>
            <input type="file" id="fileCamera" accept="image/*" capture="environment" style="display:none">
            <input type="file" id="fileFiles" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" style="display:none" multiple>
            <div class="upload-zone" onclick="document.getElementById('fileFiles').click()">
                <div class="uz-icon">üìÅ</div>
                <div class="uz-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <div class="uz-hint">–§–æ—Ç–æ, —Å–∫–∞–Ω—ã, PDF ‚Äî –¥–æ 10 –ú–ë</div>
            </div>
            <div class="upload-actions">
                <button class="upload-action-btn" onclick="document.getElementById('fileGallery').click()"><span class="ua-icon">üñº</span>–ú–µ–¥–∏–∞—Ç–µ–∫–∞</button>
                <button class="upload-action-btn" onclick="document.getElementById('fileCamera').click()"><span class="ua-icon">üì∑</span>–°–Ω–∏–º–æ–∫</button>
                <button class="upload-action-btn" onclick="document.getElementById('fileFiles').click()"><span class="ua-icon">üìé</span>–§–∞–π–ª—ã</button>
            </div>
            <div id="uploadStatus"></div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">üìã</span> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã—Å–ª–∞–Ω–Ω—ã–µ</div>
            <div id="recentDocs"><div class="loading-state"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div></div>
        </div>
        <div class="back-row"><button class="btn btn-secondary" onclick="showScreen('page-dashboard')"><span class="btn-icon">‚Üê</span> –í–µ—Ä–Ω—É—Ç—å—Å—è</button></div>
    </div>

    <!-- PAGE 5: CHAT -->
    <div id="page-chat" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üí¨</span> –ß–∞—Ç —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</div>
            <div class="chat-box" id="chatMessages"><div class="loading-state"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div></div>
            <div class="chat-input-row">
                <textarea id="chatInput" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>
        <div class="back-row"><button class="btn btn-secondary" onclick="showScreen('page-dashboard')"><span class="btn-icon">‚Üê</span> –í–µ—Ä–Ω—É—Ç—å—Å—è</button></div>
    </div>

    <!-- PAGE 6: INVOICE -->
    <div id="page-invoice" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üìù</span> –°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä—É</div>
            <div class="toggle-row">
                <button class="toggle-opt active" onclick="setInvoiceType('proforma',this)">–ü—Ä–æ—Ñ–æ—Ä–º–∞</button>
                <button class="toggle-opt" onclick="setInvoiceType('faktura',this)">–§–∞–∫—Ç—É—Ä–∞</button>
            </div>
            <div class="form-group">
                <label class="form-label">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ)</label>
                <input type="text" class="form-input" id="invContractor" placeholder="Nazwa kontrahenta">
            </div>
            <div class="form-group">
                <label class="form-label">NIP –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</label>
                <div style="display:flex;gap:8px;">
                    <input type="tel" class="form-input" id="invNip" placeholder="0000000000" maxlength="10" inputmode="numeric" style="flex:1;">
                    <button class="btn btn-outline" style="width:auto;padding:14px 16px;margin:0;" onclick="lookupNip()">üîç</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞</label>
                <input type="text" class="form-input" id="invNumber" placeholder="–ê–≤—Ç–æ" readonly style="background:#f0f2f5;color:var(--text3);">
            </div>
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ (PLN)</label>
                <input type="text" class="form-input" id="invAmount" placeholder="0.00" inputmode="decimal">
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
                <input type="text" class="form-input" id="invPurpose" placeholder="Za us≈Çugi...">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ</label>
                    <input type="date" class="form-input" id="invDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                    <select class="form-input" id="invPayType">
                        <option value="przelew">–ë–µ–∑–Ω–∞–ª</option>
                        <option value="gotowka">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                        <option value="karta">–ö–∞—Ä—Ç–∞</option>
                    </select>
                </div>
            </div>
            <div class="invoice-actions">
                <button class="btn btn-primary" onclick="invoiceAction('email')"><span class="btn-icon">üìß</span> –í—ã—Å–ª–∞—Ç—å e-mail</button>
                <button class="btn btn-green" onclick="invoiceAction('pdf')"><span class="btn-icon">üìÑ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF</button>
                <button class="btn btn-outline" onclick="invoiceAction('ksef')"><span class="btn-icon">üèõ</span> –í—ã—Å–ª–∞—Ç—å KSeF</button>
            </div>
        </div>
        <div class="back-row"><button class="btn btn-secondary" onclick="showScreen('page-dashboard')"><span class="btn-icon">‚Üê</span> –í–µ—Ä–Ω—É—Ç—å—Å—è</button></div>
    </div>

    <!-- PAGE INFO -->
    <div id="page-info" class="screen">
        <div class="card">
            <div class="card-title"><span class="icon">üí∞</span> –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</div>
            <div class="info-row"><span class="ir-label">–ü—Ä–∏—Ö–æ–¥</span><span class="ir-value" id="infoPrihod">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">–†–∞—Å—Ö–æ–¥</span><span class="ir-value" id="infoRashod">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">–î–æ—Ö–æ–¥</span><span class="ir-value" id="infoDohod">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">–ù–î–° (VAT)</span><span class="ir-value" id="infoVat">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">PIT</span><span class="ir-value" id="infoPit">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">ZUS</span><span class="ir-value" id="infoZus">‚Äî</span></div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">üìÑ</span> –î–µ–∫–ª–∞—Ä–∞—Ü–∏–∏</div>
            <div id="infoDeclarations"><div class="loading-state"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div></div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">‚öôÔ∏è</span> –¢–∞—Ä–∏—Ñ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
            <div class="info-row"><span class="ir-label">–¢–∞—Ä–∏—Ñ</span><span class="ir-value" id="infoTariff">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="ir-value" id="infoPrice">‚Äî</span></div>
            <div class="info-row"><span class="ir-label">–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç—ë–∂</span><span class="ir-value" id="infoNextPay">‚Äî</span></div>
        </div>
        <button class="btn btn-secondary" onclick="showScreen('page-company')" style="margin-bottom:8px;"><span class="btn-icon">üè¢</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</button>
        <div class="back-row"><button class="btn btn-secondary" onclick="showScreen('page-dashboard')"><span class="btn-icon">‚Üê</span> –í–µ—Ä–Ω—É—Ç—å—Å—è</button></div>
    </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = 'https://n8n.ai-finanse.pl/webhook/finansemg';
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.enableClosingConfirmation(); }
const telegramId = tg?.initDataUnsafe?.user?.id?.toString() || 'demo_user';

let currentInvoiceType = 'proforma';
let clientData = null;
let isFirstLogin = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(endpoint, data = {}) {
    const res = await fetch(`${API}/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telegram_id: telegramId, ...data })
    });
    return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (tg) { id === 'page-login' ? tg.BackButton.hide() : tg.BackButton.show(); }
    if (id === 'page-dashboard') loadDashboard();
    if (id === 'page-upload') loadRecentDocs();
    if (id === 'page-chat') loadChat();
    if (id === 'page-info') loadFullInfo();
    if (id === 'page-company') {
        document.getElementById('compBackBtn').style.display = isFirstLogin ? 'none' : 'flex';
        if (clientData) fillCompanyForm(clientData);
    }
}

if (tg) {
    tg.BackButton.onClick(() => {
        const a = document.querySelector('.screen.active');
        if (a.id === 'page-dashboard' || a.id === 'page-login') tg.close();
        else showScreen('page-dashboard');
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 1: LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const codeDigits = document.querySelectorAll('.code-digit');
codeDigits.forEach((inp, idx) => {
    inp.addEventListener('input', e => {
        const v = e.target.value.replace(/\D/g, '');
        e.target.value = v;
        if (v && idx < 5) codeDigits[idx + 1].focus();
        e.target.classList.toggle('filled', !!v);
        const code = Array.from(codeDigits).map(d => d.value).join('');
        if (code.length === 6) verifyCode(code);
    });
    inp.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) {
            codeDigits[idx-1].focus();
            codeDigits[idx-1].value = '';
            codeDigits[idx-1].classList.remove('filled');
        }
    });
});

async function verifyCode(code) {
    try {
        const data = await api('verify-code', { code });
        if (!data.success) throw new Error();
        clientData = data.client;
        isFirstLogin = !data.client.company_name;
        toast('success', '‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
        showScreen(isFirstLogin ? 'page-company' : 'page-dashboard');
    } catch {
        codeDigits.forEach(d => {
            d.classList.add('error-shake'); d.value = ''; d.classList.remove('filled');
            setTimeout(() => d.classList.remove('error-shake'), 500);
        });
        codeDigits[0].focus();
        toast('error', '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 11: FORGOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function verifyIdentity() {
    const nip = document.getElementById('forgotNip').value.trim();
    const pesel = document.getElementById('forgotPesel').value.trim();
    if (nip.length !== 10) { toast('error', 'NIP: 10 —Ü–∏—Ñ—Ä'); return; }
    if (pesel.length !== 11) { toast('error', 'PESEL: 11 —Ü–∏—Ñ—Ä'); return; }
    try {
        const d = await api('verify-identity', { nip, pesel });
        if (!d.success) throw new Error();
        showScreen('page-newcode');
        toast('success', '‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞');
    } catch { toast('error', '‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 12: NEW CODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveNewCode() {
    const c1 = document.getElementById('newCode').value.trim();
    const c2 = document.getElementById('confirmCode').value.trim();
    if (c1.length !== 6) { toast('error', '–ö–æ–¥: 6 —Ü–∏—Ñ—Ä'); return; }
    if (c1 !== c2) { toast('error', '–ö–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
    try {
        await api('set-code', { new_code: c1 });
        toast('success', '‚úÖ –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω!');
        setTimeout(() => showScreen('page-login'), 1000);
    } catch { toast('error', '‚ùå –û—à–∏–±–∫–∞'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 2: COMPANY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('compIban')?.addEventListener('input', e => {
    const v = e.target.value.replace(/\s/g, '').toUpperCase();
    document.getElementById('swiftGroup').style.display = (/^[A-Z]{2}/.test(v) && !v.startsWith('PL')) ? 'block' : 'none';
});

function fillCompanyForm(d) {
    if (!d) return;
    document.getElementById('compName').value = d.company_name || '';
    document.getElementById('compStreet').value = d.street || '';
    document.getElementById('compBuilding').value = d.building || '';
    document.getElementById('compZip').value = d.zip || '';
    document.getElementById('compCity').value = d.city || '';
    document.getElementById('compCountry').value = d.country || 'PL';
    document.getElementById('compNip').value = d.nip || '';
    document.getElementById('compIban').value = d.iban || '';
    document.getElementById('compSwift').value = d.swift || '';
    document.getElementById('compPkd').value = d.pkd || '';
}

async function saveCompanyData() {
    const p = {
        company_name: document.getElementById('compName').value.trim(),
        street: document.getElementById('compStreet').value.trim(),
        building: document.getElementById('compBuilding').value.trim(),
        zip: document.getElementById('compZip').value.trim(),
        city: document.getElementById('compCity').value.trim(),
        country: document.getElementById('compCountry').value,
        nip: document.getElementById('compNip').value.trim(),
        iban: document.getElementById('compIban').value.trim(),
        swift: document.getElementById('compSwift').value.trim(),
        pkd: document.getElementById('compPkd').value.trim(),
    };
    if (!p.company_name) { toast('error', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    if (!p.nip || p.nip.length !== 10) { toast('error', 'NIP: 10 —Ü–∏—Ñ—Ä'); return; }
    try {
        await api('save-company', p);
        clientData = { ...clientData, ...p };
        toast('success', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        if (isFirstLogin) { isFirstLogin = false; setTimeout(() => showScreen('page-dashboard'), 800); }
    } catch { toast('error', '‚ùå –û—à–∏–±–∫–∞'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 3: DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDashboard() {
    try {
        const d = await api('get-dashboard');
        document.getElementById('dPrihod').textContent = fmt(d.prihod);
        document.getElementById('dRashod').textContent = fmt(d.rashod);
        document.getElementById('dDohod').textContent = fmt(d.dohod);
        document.getElementById('dVat').textContent = fmt(d.vat);
        document.getElementById('dPit').textContent = fmt(d.pit);
        document.getElementById('dZus').textContent = fmt(d.zus);
    } catch { toast('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
}

function fmt(v) {
    if (v === undefined || v === null || v === '') return '0 z≈Ç';
    const n = parseFloat(v);
    return isNaN(n) ? v + ' z≈Ç' : n.toLocaleString('pl-PL') + ' z≈Ç';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 4: UPLOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
['fileGallery','fileCamera','fileFiles'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', async e => {
        const files = e.target.files;
        if (!files.length) return;
        const st = document.getElementById('uploadStatus');
        st.innerHTML = '<div style="padding:12px;background:var(--brand-light);border-radius:8px;color:var(--brand);font-size:14px;text-align:center;">üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º...</div>';
        try {
            for (let f of files) {
                const fd = new FormData();
                fd.append('file', f);
                fd.append('telegram_id', telegramId);
                fd.append('filename', f.name);
                await fetch(`${API}/upload`, { method: 'POST', body: fd });
            }
            st.innerHTML = '<div style="padding:12px;background:var(--green-bg);border-radius:8px;color:var(--green);font-size:14px;text-align:center;">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ!</div>';
            setTimeout(() => { st.innerHTML = ''; loadRecentDocs(); }, 2500);
        } catch {
            st.innerHTML = '<div style="padding:12px;background:var(--red-bg);border-radius:8px;color:var(--red);font-size:14px;text-align:center;">‚ùå –û—à–∏–±–∫–∞</div>';
        }
        e.target.value = '';
    });
});

async function loadRecentDocs() {
    try {
        const docs = await api('get-docs');
        const list = Array.isArray(docs) ? docs : [];
        document.getElementById('recentDocs').innerHTML = list.length
            ? list.map(d => `<div class="doc-item"><span class="di-icon">${d.icon||'üìÑ'}</span><div><div class="di-name">${d.filename||d.name||'–î–æ–∫—É–º–µ–Ω—Ç'}</div><div class="di-date">${d.date||d.uploaded_at||''}</div></div></div>`).join('')
            : '<p style="color:var(--text3);text-align:center;padding:20px;">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>';
    } catch { document.getElementById('recentDocs').innerHTML = '<p style="color:var(--text3);text-align:center;padding:20px;">–û—à–∏–±–∫–∞</p>'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 5: CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadChat() {
    try {
        const msgs = await api('get-messages');
        const list = Array.isArray(msgs) ? msgs : [];
        const box = document.getElementById('chatMessages');
        if (!list.length) { box.innerHTML = '<p style="color:var(--text3);text-align:center;padding:40px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>'; return; }
        box.innerHTML = list.map(m => `<div class="msg ${m.from}"><div class="msg-sender">${m.from==='client'?'–í—ã':'–ú–µ–Ω–µ–¥–∂–µ—Ä'}</div><div>${m.text}</div><div class="msg-time">${m.time||''}</div></div>`).join('');
        box.scrollTop = box.scrollHeight;
    } catch { document.getElementById('chatMessages').innerHTML = '<p style="color:var(--text3);text-align:center;padding:40px;">–û—à–∏–±–∫–∞</p>'; }
}

async function sendChatMessage() {
    const inp = document.getElementById('chatInput');
    const txt = inp.value.trim();
    if (!txt) return;
    appendMsg('client', txt);
    inp.value = '';
    try { await api('send-message', { message: txt }); }
    catch { toast('error', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}

function appendMsg(from, text) {
    const box = document.getElementById('chatMessages');
    const ph = box.querySelector('p'); if (ph) ph.remove();
    const t = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    box.insertAdjacentHTML('beforeend', `<div class="msg ${from}"><div class="msg-sender">${from==='client'?'–í—ã':'–ú–µ–Ω–µ–¥–∂–µ—Ä'}</div><div>${text}</div><div class="msg-time">${t}</div></div>`);
    box.scrollTop = box.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 6: INVOICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setInvoiceType(type, btn) {
    currentInvoiceType = type;
    document.querySelectorAll('.toggle-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

async function lookupNip() {
    const nip = document.getElementById('invNip').value.trim();
    if (nip.length !== 10) { toast('error', 'NIP: 10 —Ü–∏—Ñ—Ä'); return; }
    try {
        toast('success', 'üîç –ü–æ–∏—Å–∫...');
        const d = await api('lookup-nip', { nip });
        if (d.name) { document.getElementById('invContractor').value = d.name; toast('success', '‚úÖ –ù–∞–π–¥–µ–Ω'); }
        else toast('error', '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω');
    } catch { toast('error', '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'); }
}

async function invoiceAction(action) {
    const d = {
        type: currentInvoiceType,
        contractor: document.getElementById('invContractor').value.trim(),
        contractor_nip: document.getElementById('invNip').value.trim(),
        amount: document.getElementById('invAmount').value.trim(),
        purpose: document.getElementById('invPurpose').value.trim(),
        due_date: document.getElementById('invDueDate').value,
        pay_type: document.getElementById('invPayType').value,
        action
    };
    if (!d.contractor) { toast('error', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞'); return; }
    if (!d.amount) { toast('error', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; }
    try {
        toast('success', '‚è≥ –§–æ—Ä–º–∏—Ä—É–µ–º...');
        const r = await api('create-invoice', d);
        if (r.success) {
            const num = r.invoice_number || '';
            if (action === 'email') toast('success', '‚úÖ ' + num + ' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            else if (action === 'pdf') { toast('success', '‚úÖ PDF ' + num); if (r.pdf_url) window.open(r.pdf_url, '_blank'); }
            else if (action === 'ksef') toast('success', 'üèõ KSeF ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        } else throw new Error();
    } catch { toast('error', '‚ùå –û—à–∏–±–∫–∞'); }
}

document.getElementById('invDueDate').value = new Date(Date.now()+14*864e5).toISOString().split('T')[0];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE INFO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFullInfo() {
    try {
        const d = await api('get-dashboard');
        document.getElementById('infoPrihod').textContent = fmt(d.prihod);
        document.getElementById('infoRashod').textContent = fmt(d.rashod);
        document.getElementById('infoDohod').textContent = fmt(d.dohod);
        document.getElementById('infoVat').textContent = fmt(d.vat);
        document.getElementById('infoPit').textContent = fmt(d.pit);
        document.getElementById('infoZus').textContent = fmt(d.zus);
        if (clientData) {
            document.getElementById('infoTariff').textContent = clientData.tariff || '‚Äî';
            document.getElementById('infoPrice').textContent = clientData.price ? clientData.price + ' z≈Ç/–º–µ—Å' : '‚Äî';
            document.getElementById('infoNextPay').textContent = clientData.next_payment || '‚Äî';
        }
        document.getElementById('infoDeclarations').innerHTML = '<p style="color:var(--text3);text-align:center;padding:16px;">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>';
    } catch { toast('error', '–û—à–∏–±–∫–∞'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(type, msg) {
    document.querySelectorAll('.alert-toast').forEach(t => t.remove());
    const el = document.createElement('div');
    el.className = `alert-toast ${type}`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

setTimeout(() => codeDigits[0]?.focus(), 300);
</script>
</body>
</html>
